name: HAAI CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: '3.11'
  COVERAGE_THRESHOLD: 80

jobs:
  lint:
    name: Lint and Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install linting tools
        run: |
          pip install --upgrade pip
          pip install flake8 black isort mypy pytest-cov

      - name: Run isort (import sorting)
        run: |
          isort --check-only --diff src/ tests/

      - name: Run black (code formatting)
        run: |
          black --check --diff src/ tests/

      - name: Run flake8 (linting)
        run: |
          flake8 src/ tests/ --max-line-length=100 --extend-ignore=E203

      - name: Run mypy (type checking)
        run: |
          mypy src/ --ignore-missing-imports --no-error-summary

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        test-category:
          - unit
          - integration
          - coherence
          - performance

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install test dependencies
        run: |
          pip install pytest-asyncio pytest-cov coverage

      - name: Run tests
        run: |
          python -m pytest tests/ \
            -v \
            --tb=short \
            -m ${{ matrix.test-category }} \
            --junitxml=pytest-results.xml \
            2>&1 | tee test-output.txt || true

      - name: Show test results
        run: |
          if [ -f test-output.txt ]; then
            tail -50 test-output.txt
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.test-category }}
          path: |
            pytest-results.xml
            test-output.txt

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest-cov

      - name: Generate coverage report
        run: |
          python -m pytest tests/ \
            --cov=src/haai \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-report=html \
            -m "not performance" \
            2>&1 | tee coverage.txt || true

      - name: Check coverage threshold
        run: |
          COVERAGE=$(grep -oP 'TOTAL.*\s+\K\d+' coverage.txt || echo "0")
          echo "Coverage: ${COVERAGE}%"
          if [ "$COVERAGE" -lt "${{ env.COVERAGE_THRESHOLD }}" ]; then
            echo "Coverage $COVERAGE% is below threshold ${{ env.COVERAGE_THRESHOLD }}%"
            exit 1
          fi

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.xml
            htmlcov/

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
          verbose: true

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install security tools
        run: |
          pip install --upgrade pip
          pip install safety bandit

      - name: Run safety check
        run: |
          safety check -r requirements.txt || true

      - name: Run bandit (security linting)
        run: |
          bandit -r src/ -f txt -o bandit-report.txt || true
          cat bandit-report.txt

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: |
            bandit-report.txt

  docs:
    name: Documentation Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install documentation tools
        run: |
          pip install --upgrade pip
          pip install pydoc-markdown mkdocs mkdocstrings

      - name: Build documentation
        run: |
          pydoc-markdown --config pydoc-markdown.yml 2>&1 || true

      - name: Check for broken links
        run: |
          # Check that docs directory structure exists
          ls -la docs/ CGL_Doc_Spine/docs/ || true

      - name: Upload documentation
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: docs/

  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [lint, test, coverage, security, docs]
    if: always()
    steps:
      - name: Check job status
        run: |
          if echo "${{ needs.lint.result }}" | grep -q "failure"; then
            echo "❌ Linting failed"
            exit 1
          fi
          if echo "${{ needs.test.result }}" | grep -q "failure"; then
            echo "❌ Tests failed"
            exit 1
          fi
          if echo "${{ needs.coverage.result }}" | grep -q "failure"; then
            echo "❌ Coverage check failed"
            exit 1
          fi
          if echo "${{ needs.security.result }}" | grep -q "failure"; then
            echo "⚠️  Security scan found issues"
          fi
          echo "✅ All checks passed"
